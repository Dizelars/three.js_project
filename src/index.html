<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Гараж ЦОДД</title>
        <link rel="stylesheet" href="style/style.css">
        <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
        <script src="https://unpkg.com/aframe-particle-system-component@1.0.x/dist/aframe-particle-system-component.min.js"></script>
        <script>
            setTimeout(() => {
                AFRAME.registerComponent("hotspots", {
                    init: function () {
                        this.el.addEventListener("reloadspots", function (evt) {
                            //get the entire current spot group and scale it to 0
                            let currspotgroup = document.getElementById(evt.detail.currspots);
                            currspotgroup.setAttribute("scale", "0 0 0");

                            //get the entire new spot group and scale it to 1
                            let newspotgroup = document.getElementById(evt.detail.newspots);
                            newspotgroup.setAttribute("scale", "1 1 1");
                        });
                    }
                });

                AFRAME.registerComponent("spot", {
                    schema: {
                        linkto: { type: "string", default: "" },
                        spotgroup: { type: "string", default: "" },
                        phiStart: { type: "string", default: "" }
                    },
                    init: function () {
                        this.el.addEventListener("click", () => {
                            let cam = document.getElementById("cam");
                            cam.emit("zoomin");

                            let fp = document.getElementById("camfadeplane");
                            fp.setAttribute("width", "2");
                            fp.setAttribute("height", "2");
                            fp.emit("camFadeIn");

                            const reloadSpot = () => {
                                //set the skybox source to the new image as per the spot
                                let sky = document.getElementById("skybox");
                                sky.setAttribute("src", this.data.linkto);
                                //надобавлял говна но оно не пашет
                                sky.setAttribute("phi-start", this.data.phiStart);

                                let spotcomp = document.getElementById("spots");
                                let currspots = this.el.parentElement.getAttribute("id");
                                //create event for spots component to change the spots data
                                spotcomp.emit("reloadspots", {
                                    newspots: this.data.spotgroup,
                                    currspots: currspots
                                });

                                //this.setAttribute("camera","fov",80);
                                cam.emit("zoomout");

                                let fp = document.getElementById("camfadeplane");
                                fp.emit("camFadeOut");

                                setTimeout(() => {
                                    fp.setAttribute("width", "0");
                                    fp.setAttribute("height", "0");
                                }, 1000);
                            };
                            setTimeout(reloadSpot, 2000);
                        });

                        // this.el.addEventListener("mouseleave", function () {
                        //   var cur = document.getElementById("cursor-visual");
                        //   cur.emit("stopFuse");
                        // });

                        //поменял mouseenter на click. какая то хуйня
                        // this.el.addEventListener("click", function (evt) {
                        //   var cur = document.getElementById("cursor-visual");
                        //   cur.emit("startFuse");
                        // });
                    }
                });
            }, 1500);
        </script>
    </head>
    <body>



    <div class="progress-bar">
        <div class="progress-bar-container">
            <div class="image">
                <img src="/src/img/layout/loader/2.svg" alt="цодд">
                <p class="image-text">ЦОДД</p>
            </div>
            <span id="progress-label">0%</span>
            <progress id="progress-bar" value="0" max="100"></progress>
            <label for="progress-bar">Загрузка...</label>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <div class="header__wrapper">
                <div class="header__logo">
                    <img class="header__logo-img" src="./img/layout/header_logo.svg" alt="logo">
                    <p class="header__logo-text">Гараж ЦОДД</p>
                </div>
                <div class="header__info">
                    <img class="header__info-img" src="./img/layout/header_img2.png" alt="model_preview">
                    <div class="header__info-descr">
                        <p class="header__info-text">Дорожный патруль</p>
                        <p class="header__info-text">30 автомобилей</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div id="Canvas_wrapper"></div>
        <section class="tech_spec">
            <div class="container__content">
                <div class="tech_spec__wrapper">
                    <div class="tech_spec__description">
                        <div class="tech_spec__info-wrapper">
                            <div class="tech_spec__titles">
                                <div class="text_spec__texts">
                                    <p class="tech_spec__title">Дорожный патруль</p>
                                    <p class="tech_spec__subtitle">Автомобиль службы помощи ЦОДД</p>
                                </div>
                                <a class="tech_spec__btn-copied">
                                    <span>Скрыть</span>
                                    <img src="./img/layout/icon-arrow.svg" alt="icon-arrow">
                                </a>
                            </div>
                            <div class="tech_spec__visible hidden">
                                <div class="tech_spec__mission">
                                    <p class="tech_spec__text">Задача:</p>
                                    <p class="tech_spec__text-descr">Регулировать движение на сложных участках, помогать водителям при поломке или аварии.</p>
                                </div>
                                <div class="tech_spec__outfit">
                                    <p class="tech_spec__text">Экипировка:</p>
                                    <ul class="tech_spec__outfit-list">
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_1.svg" alt="Огнетушитель">
                                            </div>
                                            <span class="tech_spec__outfit-text">Огнетушитель</span>
                                        </li>
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_2.svg" alt="Аптечка">
                                            </div>
                                            <span class="tech_spec__outfit-text">Аптечка</span>
                                        </li>
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_3.svg" alt="Инструменты">
                                            </div>
                                            <span class="tech_spec__outfit-text">Инструменты</span>
                                        </li>
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_4.svg" alt="Трос">
                                            </div>
                                            <span class="tech_spec__outfit-text">Трос</span>
                                        </li>
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_6.svg" alt="Пусковое устройство">
                                            </div>
                                            <span class="tech_spec__outfit-text">Пусковое устройство</span>
                                        </li>
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_7.svg" alt="Бланки европротокола">
                                            </div>
                                            <span class="tech_spec__outfit-text">Бланки европротокола</span>
                                        </li>
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_8.svg" alt="Телескопическая лестница">
                                            </div>
                                            <span class="tech_spec__outfit-text">Телескопическая лестница</span>
                                        </li>
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_9.svg" alt="Домкрат">
                                            </div>
                                            <span class="tech_spec__outfit-text">Домкрат</span>
                                        </li>
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_10.svg" alt="Дорожные конусы">
                                            </div>
                                            <span class="tech_spec__outfit-text">Дорожные конусы</span>
                                        </li>
                                        <li class="tech_spec__outfit-item">
                                            <div class="tech_spec__outfit-img">
                                                <img src="./img/layout/outfit/outfit_11.svg" alt="Гайковерт">
                                            </div>
                                            <span class="tech_spec__outfit-text">Гайковерт</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <a class="tech_spec__btn">
                            <span>Подробнее</span>
                            <img src="./img/layout/icon-arrow.svg" alt="icon-arrow">
                        </a>
                    </div>
                </div>
            </div>
        </section>
        <div class="tech_spec__interior">
            <div class="tech_spec__interior-btn">
                <span class="tech_spec__interior-text">В салон</span>
                <div class="arrow-wrapper">
                    <img src="./img/layout/interior_arrow.svg" alt="interior_arrow">
                </div>
            </div>
        </div>
    </main>

    <section class="auto_park">
        <div class="container">
            <div class="auto_park_wrapper">
                <div class="auto_park__control">
                    <p class="auto_park__title">Транспорт ЦОДД</p>
                    <img class="rotate" src="./img/layout/auto_park_arrow.svg" alt="auto_park_btn">
                </div>
                <div class="auto_park_slider">
                    <div class="auto_park_slider-overflow">
                        <div class="auto_park_slider-wrapper">
                            <div class="gallery_item active">
                                <a class="gallery_item_link" href="#">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_amarok2.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="./pages/solaris.html">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_solara_1.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="./pages/solaris_two.html">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_solara_2.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="./pages/bus.html">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_bus.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="#">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_amarok2.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="./pages/solaris.html">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_solara_1.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="./pages/solaris_two.html">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_solara_2.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="./pages/bus.html">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_bus.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="#">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_amarok2.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="./pages/solaris.html">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_solara_1.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="./pages/solaris_two.html">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_solara_2.png" alt="slide">
                                </a>
                            </div>
                            <div class="gallery_item">
                                <a class="gallery_item_link" href="./pages/bus.html">
                                    <img class="gallery_item-img" src="./img/layout/slider/slide_bus.png" alt="slide">
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="auto_park_slider-button">
                        <button class="prev_button">
                            <img src="./img/layout/slider/icon-arrow.png" alt="arrow_prev">
                        </button>
                        <button class="next_button">
                            <img src="./img/layout/slider/icon-arrow.png" alt="arrow_next">
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <a-scene>
        <a-assets>
            <script id="flatShader" type="x-shader/x-fragment">
          varying vec2 vUv;
          void main() {
            gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
          }
        </script>

            <img
                    id="room1"
                    src="https://coddmac.store/THREE/360/amarok/Interior.jpg"
                    crossorigin="anonymous"
                    importance="high"
            />
            <img
                    id="room2"
                    src="https://coddmac.store/THREE/360/largus/Interior.jpg"
                    crossorigin="anonymous"
                    importance="low"
            />
            <img
                    id="room3"
                    src="https://coddmac.store/BKL/360/Varshavskaya/3.jpg"
                    crossorigin="anonymous"
                    importance="low"
            />
            <img
                    id="room4"
                    src="https://coddmac.store/BKL/360/Varshavskaya/4.jpg"
                    crossorigin="anonymous"
                    importance="low"
            />
            <img
                    id="room5"
                    src="https://coddmac.store/BKL/360/Varshavskaya/5.jpg"
                    crossorigin="anonymous"
                    importance="low"
            />
            <img
                    id="hotspot"
                    src="https://coddmac.store/BKL/360/source/Hotspot_blue_big.svg"
                    crossorigin="anonymous"
            />

            <img
                    id="crossIcon"
                    src="https://coddmac.store/THREE/360/cross-icon.svg"
                    crossorigin="anonymous"
                    importance="low"
            />

            <img
                    id="text-01"
                    src="https://coddmac.store/THREE/360/text/text-01.svg"
                    crossorigin="anonymous"
                    importance="low"
            />

            <img
                    id="text-02"
                    src="https://coddmac.store/THREE/360/text/text-02.svg"
                    crossorigin="anonymous"
                    importance="low"
            />

            <a-mixin
                    id="info-sphere"
                    geometry="primitive: sphere; radius: 0.4;"
                    material="color: #ff0000;"
            ></a-mixin>

            <template id="infoPanel1">
                <a-plane
                        color="black"
                        material="shader: flat"
                        height="2"
                        width="4"
                        position="0 0 0"
                        rounded="2.8"
                >
                    <a-image
                            position="0 0 0.1"
                            src="#text-02"
                            width="4"
                            height="1"
                            height="0.3"
                    ></a-image>
                    <a-image
                            position="1.7 0.7 0.1"
                            src="#crossIcon"
                            width="0.33"
                            height="0.33"
                    ></a-image>
                </a-plane>
            </template>

            <template id="infoPanel2">
                <a-plane
                        color="black"
                        material="shader: flat"
                        height="2"
                        width="4"
                        position="0 0 0"
                        rounded="2.8"
                >
                    <a-image
                            position="0 0 0.1"
                            src="#text-01"
                            width="4"
                            height="1"
                            height="0.3"
                    ></a-image>
                    <a-image
                            position="1.7 0.7 0.1"
                            src="#crossIcon"
                            width="0.33"
                            height="0.33"
                    ></a-image>
                </a-plane>
            </template>
        </a-assets>

        <!-- room teleport hotspots -->

        <a-entity id="spots" hotspots="">
            <a-entity id="group-room1">
                <a-image
                        src="#hotspot"
                        spot="linkto:#room2;spotgroup:group-room2;phiStart:0"
                        position="0 -2 8"
                        look-at
                ></a-image>

                <a-entity position="0 1 6" look-at rotation="180 0 180">
                    <a-entity mixin="info-sphere" id="sphere1"> </a-entity>
                    <a-entity id="infoPanelContainer1"></a-entity>
                </a-entity>

                <a-entity position="-4.5 -1.75 -8" look-at>
                    <a-entity mixin="info-sphere" id="sphere2"> </a-entity>
                    <a-entity id="infoPanelContainer2"></a-entity>
                </a-entity>
            </a-entity>

            <a-entity id="group-room2" scale="0 0 0">
                <a-image
                        spot="linkto:#room1;spotgroup:group-room1;phiStart:175"
                        src="#hotspot"
                        position="0 1 8"
                        look-at
                ></a-image>
            </a-entity>

            <a-entity id="group-room3" scale="0 0 0">
                <a-image
                        spot="linkto:#room2;spotgroup:group-room2;phiStart:146"
                        src="#hotspot"
                        position="0 1 8"
                        look-at
                ></a-image>
                <a-image
                        spot="linkto:#room4;spotgroup:group-room4;phiStart:90"
                        src="#hotspot"
                        position="0 1 -8"
                        look-at
                ></a-image>
            </a-entity>

            <a-entity id="group-room4" scale="0 0 0">
                <a-image
                        spot="linkto:#room3;spotgroup:group-room3;phiStart:120"
                        src="#hotspot"
                        position="0 1 8"
                        look-at
                ></a-image>
                <a-image
                        spot="linkto:#room5;spotgroup:group-room5;phiStart:90"
                        src="#hotspot"
                        position="0 1 8"
                        look-at
                ></a-image>
            </a-entity>

            <a-entity id="group-room5" scale="0 0 0">
                <a-image
                        spot="linkto:#room4;spotgroup:group-room4;phiStart:90"
                        src="#hotspot"
                        position="0 1 8"
                        look-at
                ></a-image>
            </a-entity>
        </a-entity>

        <a-entity
                id="cam"
                camera="fov:80"
                position="0 1.6 0"
                look-controls
                cursor="rayOrigin: mouse"
                animation__zoomin="property:camera.fov;dur:2000;to:50;startEvents:zoomin;"
                animation__zoomout="property:camera.fov;dur:1000;to:80;startEvents:zoomout;"
        >
            <a-plane
                    id="camfadeplane"
                    rotation="10 0.5 0"
                    position="0 0 -0.5"
                    material="color:#000000;transparent:true;opacity:0"
                    width="0"
                    height="0"
                    animation__fadein="property:material.opacity;to:1;dur:2000;startEvents:camFadeIn"
                    animation__fadeout="property:material.opacity;to:0;dur:1000;startEvents:camFadeOut"
            ></a-plane>
        </a-entity>

        <a-sky id="skybox" src="#room1" rotation="0 0 0" phi-start="175"></a-sky>
    </a-scene>

    <script type="module" src="js/three/my_three.js"></script>
    <script>
        setTimeout(() => {
            let currentInfoPanel = null;

            // Open the panel
            document
                .querySelectorAll('[mixin="info-sphere"]')
                .forEach(function (sphere) {
                    sphere.addEventListener("click", function () {
                        console.log("Info sphere clicked: " + this.id);

                        const currentSphereIdNumber = this.id.replace("sphere", "");

                        // Get the template for this info sphere
                        const template = document.querySelector(
                            "#infoPanel" + currentSphereIdNumber
                        );

                        // Get the info panel entity
                        const infoPanel = document.querySelector(
                            "#infoPanelContainer" + currentSphereIdNumber
                        );

                        console.log("Current info panel: ", infoPanel);

                        // Instantiate the new info panel from the template
                        infoPanel.appendChild(document.importNode(template.content, true));

                        const allInfoPanelContainerElements = document.querySelectorAll(
                            "[id^=infoPanelContainer]"
                        );

                        document
                            .querySelectorAll('[src="#crossIcon"]')
                            .forEach(function (cross) {
                                cross.addEventListener("click", function () {
                                    allInfoPanelContainerElements.forEach((container) => {
                                        if (container.id === infoPanel.id) {
                                            container.innerHTML = "";
                                            document
                                                .querySelector("#sphere" + currentInfoPanel)
                                                .setAttribute("visible", true);
                                        }
                                    });
                                });
                            });

                        allInfoPanelContainerElements.forEach((container) => {
                            if (container.id !== infoPanel.id) {
                                container.innerHTML = "";
                            }
                            this.setAttribute("visible", true);
                        });

                        // console.log("Current info panel insides: ", infoPanel.innerHTML);

                        const idNumber = currentSphereIdNumber;
                        if (currentInfoPanel) {
                            document
                                .querySelector("#sphere" + currentInfoPanel)
                                .setAttribute("visible", true);
                        }
                        // document.querySelector("#info" + idNumber).style.display = "block";
                        this.setAttribute("visible", false);
                        currentInfoPanel = idNumber;
                        console.log("Current info panel id: " + currentInfoPanel);
                    });
                });
        }, 1500);
    </script>
<!--    <script>-->
<!--        AFRAME.registerComponent('rotation-reader', {-->
<!--            init() {-->
<!--                this.onDeviceOrientation = this.onDeviceOrientation.bind(this);-->
<!--                this.addEventListeners();-->
<!--                // const modalAframe = document.querySelector('.a-modal');-->
<!--                // const modalAframe2 = document.getElementById('ar-permission-overlay');-->
<!--                // console.log(modalAframe);-->
<!--                // console.log(modalAframe2);-->
<!--            },-->

<!--            addEventListeners() {-->
<!--                // Проверка поддержки гироскопа-->
<!--                if (window.DeviceOrientationEvent && typeof window.DeviceOrientationEvent.requestPermission === 'function') {-->
<!--                    // Запрос доступа к гироскопу-->
<!--                    window.DeviceOrientationEvent.requestPermission().then(permissionState => {-->
<!--                        if (permissionState === 'granted') {-->
<!--                            window.addEventListener('deviceorientation', this.onDeviceOrientation);-->
<!--                        }-->
<!--                    }).catch(console.error);-->
<!--                } else {-->
<!--                    window.addEventListener('deviceorientation', this.onDeviceOrientation);-->
<!--                }-->
<!--            },-->

<!--            onDeviceOrientation(event) {-->
<!--                const cameraEl = this.el;-->
<!--                const { alpha, beta, gamma } = event;-->

<!--                // Применение поворота к камере-->
<!--                cameraEl.setAttribute('rotation', {-->
<!--                    x: beta,-->
<!--                    y: alpha,-->
<!--                    z: -gamma-->
<!--                });-->
<!--            }-->
<!--        });-->
<!--    </script>-->
    </body>
</html>